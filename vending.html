#include <WiFi.h>
#include <HTTPClient.h>
#include <WiFiClientSecure.h> 
#include <ArduinoJson.h>
// Hapus library ESP32Servo karena kita pakai mode saklar ON/OFF biasa

// --- KONFIGURASI WIFI ---
const char* ssid = "Galaxy_A23";
const char* password = "@dzFawAzz";

String serverUrl = "https://vending-machine-server.fahmyainun.workers.dev";

// --- KONFIGURASI PIN MOTOR (OUTPUT ON/OFF) ---
// Logic: HIGH = Nyala (Motor Jalan), LOW = Mati (Motor Stop)
int pinMotor1 = 13;  
int pinMotor2 = 14; 
int pinMotor3 = 12;  
int pinMotor4 = 27; 

// --- KONFIGURASI PIN SENSOR (LIMIT SWITCH) ---
// Logic: INPUT_PULLUP (Normal HIGH, saat kena Ground jadi LOW)
int sensor1 = 26; 
int sensor2 = 33; 
int sensor3 = 32;    
int sensor4 = 25; 

unsigned long lastServerCheck = 0;
const long serverInterval = 5000; 

// Deklarasi Fungsi (Sekarang parameternya int pinMotor, bukan Servo object)
void prosesVending(int pinMotor, int pinSensor, int quantity); 
void checkServer();
void confirmDispense(String orderId);

void setup() {
  Serial.begin(115200);

  // 1. Setup Pin SENSOR
  pinMode(sensor1, INPUT_PULLUP);
  pinMode(sensor2, INPUT_PULLUP);
  pinMode(sensor3, INPUT_PULLUP);
  pinMode(sensor4, INPUT_PULLUP); 

  // 2. Setup Pin MOTOR sebagai OUTPUT
  pinMode(pinMotor1, OUTPUT); digitalWrite(pinMotor1, LOW); // Pastikan mati dulu
  pinMode(pinMotor2, OUTPUT); digitalWrite(pinMotor2, LOW);
  pinMode(pinMotor3, OUTPUT); digitalWrite(pinMotor3, LOW);
  pinMode(pinMotor4, OUTPUT); digitalWrite(pinMotor4, LOW);

  // Setup WiFi
  WiFi.begin(ssid, password);
  Serial.println("\nSedang menghubungkan ke WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n‚úÖ WiFi Connected!");
  
  Serial.println("\n=============================================");
  Serial.println("  SISTEM READY (RELAY/DC MOTOR MODE)  ");
  Serial.println("=============================================");
}

void loop() {
  if (WiFi.status() != WL_CONNECTED) {
    WiFi.disconnect();
    WiFi.reconnect();
    delay(1000);
    return;
  }

  unsigned long currentMillis = millis();
  if (currentMillis - lastServerCheck >= serverInterval) {
    lastServerCheck = currentMillis;
    checkServer(); 
  }
}

void checkServer() {
  WiFiClientSecure client;
  client.setInsecure(); 
  HTTPClient http;
  String checkUrl = serverUrl + "/hardware/check";
  
  Serial.print("."); 

  if (!http.begin(client, checkUrl)) {
    Serial.println("\n‚ùå Gagal connect ke URL!");
    return; 
  }

  int httpCode = http.GET();
  
  if (httpCode > 0) {
      if (httpCode == 200) {
          String payload = http.getString();
          StaticJsonDocument<1024> doc;
          DeserializationError error = deserializeJson(doc, payload);

          if (error) return;

          bool isAvailable = doc["available"];

          if (isAvailable) {
            String productId = doc["product_id"].as<String>();
            String orderId = doc["order_id"].as<String>(); 
            int qty = doc["quantity"];

            Serial.println("\n\nüî• === ORDER BARU MASUK! ===");
            Serial.println("Produk: " + productId + " | Qty: " + String(qty));
            
            // LOGIKA MAPPING MOTOR (ON/OFF)
            // Mengirim nomor PIN Motor, bukan object servo
            if (productId == "p11") {
               prosesVending(pinMotor1, sensor1, qty); 
            } else if (productId == "p12") {
               prosesVending(pinMotor2, sensor2, qty); 
            } else if (productId == "p13") {
               prosesVending(pinMotor3, sensor3, qty); 
            } else if (productId == "p14") {
               Serial.println(" --> Menyalakan Motor 4 (Pin 27)");
               prosesVending(pinMotor4, sensor4, qty); 
            } else {
               Serial.println("‚ö†Ô∏è ID Produk tidak dikenali!");
            }

            confirmDispense(orderId);
          } 
      }
  }
  http.end();
}

// --- FUNGSI EKSEKUSI VENDING (MODE ON/OFF) ---
void prosesVending(int pinMotor, int pinSensor, int quantity) {
  
  Serial.print("\n--- PROSES VENDING ---");
  Serial.print(" Motor Pin: "); Serial.print(pinMotor);
  Serial.print(" | Sensor Pin: "); Serial.println(pinSensor); 

  for(int i=0; i<quantity; i++) {
    Serial.print("\nüì¶ Item ke-"); Serial.println(i+1);
    
    // 1. NYALAKAN MOTOR (HIGH)
    // Ini akan memicu Relay aktif / Transistor ON
    digitalWrite(pinMotor, HIGH); 
    Serial.println(" üü¢ MOTOR ON (HIGH)... Menunggu Sensor...");
    
    // 2. MONITOR SENSOR (Tunggu sampai LOW / Grounded)
    unsigned long startTime = millis();
    bool sensorTriggered = false;
    
    // Loop monitoring (Maksimal 8 Detik biar motor gak panas kalau macet)
    while(millis() - startTime < 8000) {
      
      int status = digitalRead(pinSensor);
      
      // Jika sensor kena Ground (Active LOW)
      if (status == LOW) {
        sensorTriggered = true;
        Serial.println("\n üõë SENSOR KENA GROUND! STOP MOTOR!");
        break; 
      }
      
      delay(10); 
    }

    // 3. MATIKAN MOTOR (LOW)
    digitalWrite(pinMotor, LOW); 
    
    if (!sensorTriggered) {
      Serial.println(" ‚ö†Ô∏è Warning: Timeout! Sensor tidak tersentuh dalam 8 detik.");
      // Tetap dimatikan motornya demi keamanan
      digitalWrite(pinMotor, LOW); 
    } else {
      Serial.println(" ‚úÖ Motor Berhenti Sempurna.");
    }

    delay(1000); // Jeda sebelum item berikutnya (jika qty > 1)
  }
  
  Serial.println("‚úÖ Transaksi Selesai.");
}

void confirmDispense(String orderId) {
  WiFiClientSecure client;
  client.setInsecure(); 
  HTTPClient http;
  String confirmUrl = serverUrl + "/hardware/confirm";
  
  if(http.begin(client, confirmUrl)) {
    http.addHeader("Content-Type", "application/json");
    String jsonBody = "{\"order_id\":\"" + orderId + "\"}";
    int httpResponseCode = http.POST(jsonBody);
    if(httpResponseCode > 0){
       Serial.println("‚úÖ Laporan Terkirim ke Server.");
    }
    http.end();
  }
}
