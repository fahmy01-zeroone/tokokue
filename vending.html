<script>
  // ðŸ‘‡ URL WORKER (Backend)
  const API_BASE_URL = "https://vending-machine-server.fahmyainun.workers.dev"; 

  const productImages = {
    "p11": "Kue Sus.jpg",
    "p12": "Donat Kentang.jpg",
    "p13": "Roti Labu Kuning.jpg",
    "p14": "Donat Labu Kuning.jpg", 
    "default": "https://via.placeholder.com/150?text=Vending+AAA"
  };

  const vendingProductIDs = ["p11", "p12", "p13", "p14"]; 

  document.addEventListener("DOMContentLoaded", () => {
    fetchProducts();
  });

  const modal = document.getElementById("refundModal");
  const waModal = document.getElementById("waModal");

  function openRefundModal() { modal.style.display = "flex"; }
  function closeRefundModal() { modal.style.display = "none"; }

  function openWaModal() { waModal.style.display = "flex"; }
  function closeWaModal() { waModal.style.display = "none"; }

  window.onclick = function(event) { 
    if (event.target == modal) modal.style.display = "none"; 
    if (event.target == waModal) waModal.style.display = "none";
  }

  async function fetchProducts() {
    try {
      const res = await fetch(`${API_BASE_URL}/products`);
      if (!res.ok) throw new Error("Gagal ambil data: " + res.status);
      
      const allProducts = await res.json();
      const productsData = allProducts.filter(item => vendingProductIDs.includes(item.id));

      if (productsData.length === 0) {
          document.getElementById("produk-list").innerHTML = `<p style="text-align:center;">Produk vending sedang kosong.</p>`;
          return;
      }
      renderProducts(productsData);
    } catch (err) {
      console.error(err);
      document.getElementById("produk-list").innerHTML = `<p style="text-align:center; color:red">Gagal memuat: ${err.message}</p>`;
    }
  }

  function renderProducts(products) {
    const container = document.getElementById("produk-list");
    container.innerHTML = "";
    
    products.forEach(p => {
      const imgUrl = productImages[p.id] || productImages["default"];
      const isHabis = p.stock <= 0;
      
      const div = document.createElement('div');
      div.className = 'produk';
      div.innerHTML = `
          <div class="stok-badge">Stok: ${p.stock}</div>
          <img src="${imgUrl}" onerror="this.src='${productImages.default}'">
          <h3>${p.name}</h3>
          <div class="harga">Rp ${p.price.toLocaleString()}</div>
          
          <button id="btn-${p.id}" class="btn-beli" ${isHabis ? "disabled" : ""}>
            ${isHabis ? "Habis" : "ðŸ›’ Beli"}
          </button>
      `;

      if (!isHabis) {
          div.querySelector('button').onclick = function() {
              beliLangsung(p.id, p.name, p.price);
          };
      }

      container.appendChild(div);
    });
  }

  // --- LOGIKA BELI ---
  async function beliLangsung(id, nama, harga) {
    if (typeof window.snap === 'undefined') {
        alert("Sistem pembayaran belum siap (Loading...). Tunggu 3 detik lalu coba lagi.");
        return;
    }

    const btnId = "btn-" + id; 
    const btn = document.getElementById(btnId);
    if (!btn) return; 

    const originalText = btn.innerText;
    btn.innerHTML = "â³ Menghubungi Bank...";
    btn.disabled = true;

    const resetButton = () => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    };

    const myOrderId = "ORDER-" + Date.now(); 

    try {
        const response = await fetch(`${API_BASE_URL}/api/get-token`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                order_id: myOrderId,
                items: [{ id: id, quantity: 1 }], 
                product_name: "Vending: " + nama
            }) 
        });

        if (!response.ok) {
            const errText = await response.text();
            throw new Error("Server Error: " + errText);
        }

        const data = await response.json();
        
        if (data.error) { alert("Error dari Server: " + data.error); resetButton(); return; }
        if (!data.token) { alert("Gagal mendapatkan Token Pembayaran."); resetButton(); return; }

        window.snap.pay(data.token, {
            onSuccess: async function(result){
                console.log("Sukses Midtrans!", result);
                btn.innerHTML = "ðŸ”„ Memproses...";
                
                try {
                  await fetch(`${API_BASE_URL}/bayar`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      product_id: id,
                      user_token: myOrderId, 
                      quantity: 1 
                    })
                  });

                  document.getElementById("pesan-layar").innerText = "âœ… SILAKAN AMBIL: " + nama.toUpperCase();
                  document.getElementById("pesan-layar").style.color = "#2ecc71";
                  alert("Pembayaran Berhasil! Silakan ambil kue Anda ðŸ‘‡");
                  
                  fetchProducts(); 
                  resetButton();

                } catch (errDb) {
                  alert("Pembayaran masuk, tapi database error. Mohon foto bukti bayar.");
                  console.error(errDb);
                  resetButton();
                }
            },
            onPending: function(result){
                alert("Menunggu pembayaran...");
                resetButton();
            },
            onError: function(result){
                alert("Pembayaran Gagal/Dibatalkan.");
                resetButton();
            },
            onClose: function(){
                resetButton(); 
            }
        });

    } catch (error) {
        console.error("Error Beli:", error);
        alert("Gagal koneksi: " + error.message);
        resetButton();
    }
  }

  // --- LOGIKA TIMER ---
  let idleTime = 0;
  const resetTimer = () => { idleTime = 0; };
  document.onmousemove = resetTimer;
  document.onkeypress = resetTimer;
  document.ontouchstart = resetTimer; 
  document.onclick = resetTimer;

  setInterval(() => {
    idleTime++;
    if (idleTime >= 2) { 
       window.location.reload(); 
    }
  }, 60000); 
</script>

</body>
</html>
