<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vending Machine - AAA</title>   
   
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* RESET UMUM */
    body { 
      font-family: 'Poppins', sans-serif; 
      background: #2c3e50; 
      padding: 20px; 
      margin: 0; 
      color: #fff; 
      overflow-x: hidden; 
    }
    
    h1 { text-align: center; margin-bottom: 5px; font-size: 26px; transition: color 0.3s; color: #f1c40f; } 
    .subtitle { text-align: center; color: #ecf0f1; margin-bottom: 20px; font-size: 15px; }
    
    /* --- STYLE VIDEO BIOSKOP (CINEMATIC) --- */
    .video-wrapper {
      position: relative;
      width: 100vw; 
      height: 320px; 
      
      /* Trik menembus padding body 20px */
      left: 50%;
      right: 50%;
      margin-left: -50vw;
      margin-right: -50vw;
      
      overflow: hidden; 
      background: #000;
      margin-bottom: 30px;
      
      /* ANTI KLIK VIDEO */
      pointer-events: none; 
      user-select: none;
    }

    .video-wrapper iframe {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100vw; 
      height: 56.25vw; /* Rasio 16:9 */
      
      transform: translate(-50%, -50%) scale(1.3); 
      
      min-height: 350px; 
      min-width: 100%;
      
      border: none;
      opacity: 0.8; 
    }
    
    @media (max-width: 600px) {
       .video-wrapper { height: 250px; }
       .video-wrapper iframe { height: 100%; width: 180vh; }
    }

    /* --- PRODUK GRID --- */
    .produk-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
      gap: 15px;
      max-width: 800px; 
      margin: auto;
      padding-bottom: 50px; 
    }

    .produk {
      background: white; padding: 10px; border-radius: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3); text-align: center;
      transition: transform 0.3s ease; position: relative;
      display: flex; flex-direction: column; justify-content: space-between;
      color: #333;
    }
    
    .produk:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }

    .produk img {
      width: 100%; 
      aspect-ratio: 1 / 1; 
      object-fit: cover; 
      border-radius: 10px; margin-bottom: 10px;
      background-color: #eee; 
    }

    .stok-badge {
      position: absolute; top: 10px; right: 10px;
      background: rgba(0,0,0,0.7); color: white;
      padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold;
      z-index: 2;
      backdrop-filter: blur(2px);
    }

    .produk h3 { 
        margin: 5px 0; font-size: 16px; line-height: 1.3; 
        min-height: 42px; 
        display: flex; align-items: center; justify-content: center;
    }
    .harga { font-weight: 700; margin: 5px 0 10px; color: #d35400; font-size: 15px; }
    
    button.btn-beli {
      background: #e67e22; 
      color: white; border: none;
      padding: 12px 0; 
      width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;
      transition: background 0.2s, transform 0.1s;
    }
    button.btn-beli:hover { background: #d35400; }
    button.btn-beli:active { transform: scale(0.98); }
    button.btn-beli:disabled { background: #ccc; cursor: not-allowed; transform: none; }

    .loading-msg { text-align: center; width: 100%; grid-column: 1 / -1; font-style: italic; color: #ecf0f1; margin: 40px 0; }

    /* --- FOOTER & CONTACT --- */
    .footer {
      text-align: center; margin-top: 40px; padding: 30px 20px; 
      border-top: 1px solid #444; color: #bdc3c7; font-size: 14px;
      background-color: #34495e; border-radius: 14px;
    }
    
    .contact-box {
      margin-bottom: 25px; padding-bottom: 20px;
      border-bottom: 1px solid #555;
    }
    .contact-box h4 { margin: 0 0 15px; color: #fff; font-size: 16px; }

    .sosmed-btn {
      display: inline-flex; align-items: center; gap: 8px;
      text-decoration: none; color: white; font-weight: 600;
      padding: 10px 20px; border-radius: 50px; margin: 5px;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .sosmed-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .sosmed-btn i { font-size: 20px; }

    .btn-wa { background-color: #25D366; }
    .btn-wa:hover { background-color: #1da851; }
    
    .footer a.policy-link {
      color: #95a5a6; text-decoration: none; font-size: 13px; cursor: pointer;
    }
    .footer a.policy-link:hover { color: #f1c40f; text-decoration: underline; }

    /* --- MODAL STYLES --- */
    .modal-overlay {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto;
      background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
      align-items: center; justify-content: center;
    }

    .modal-content {
      background-color: #fff; margin: auto; padding: 30px;
      border-radius: 12px; width: 90%; max-width: 600px;
      position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      max-height: 80vh; overflow-y: auto; color: #333;
    }

    .close-modal {
      color: #aaa; float: right; font-size: 28px; font-weight: bold;
      cursor: pointer; position: absolute; right: 20px; top: 10px;
    }
    .close-modal:hover { color: #000; }

    .modal-body h2 { color: #333; margin-top: 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; font-size: 20px; }
    .modal-body h3 { font-size: 16px; margin-top: 15px; color: #d35400; }
    .modal-body p, .modal-body li { color: #555; line-height: 1.6; font-size: 14px; }
    .modal-body ul { padding-left: 20px; margin-bottom: 15px; }
  </style>
</head>

<body>

<h1 id="pesan-layar">ü§ñ Vending Machine AAA</h1>
<p class="subtitle">Sentuh tombol "Beli" untuk pembayaran instan (QRIS)</p>

<div class="video-wrapper">
  <iframe 
    src="https://www.youtube.com/embed/hTcBL_bg29A?autoplay=1&mute=1&loop=1&playlist=hTcBL_bg29A&controls=0&showinfo=0&rel=0&iv_load_policy=3&disablekb=1"
    title="Background Video" 
    frameborder="0" 
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
    allowfullscreen>
  </iframe>
</div>

<div class="produk-container" id="produk-list">
  <div class="loading-msg">‚è≥ Sedang mengambil kue dari mesin...</div>
</div>

<div class="footer">
  <div class="contact-box">
    <h4>Butuh Bantuan / Mesin Error?</h4>
    <a href="javascript:void(0)" onclick="openWaModal()" class="sosmed-btn btn-wa">
      <i class="fa-brands fa-whatsapp"></i> Hubungi Admin (Scan)
    </a>
  </div>
  &copy; 2025 Vending Machine AAA.<br>
  <a onclick="openRefundModal()" class="policy-link">Kebijakan & Syarat Ketentuan (S&K)</a>
</div>

<div id="refundModal" class="modal-overlay">
  <div class="modal-content">
    <span class="close-modal" onclick="closeRefundModal()">&times;</span>
    <div class="modal-body">
      <h2>Info Vending Machine</h2>
      <h3>1. Cara Pembelian</h3>
      <p>Sistem ini menggunakan <strong>Pembayaran Langsung (Direct Payment)</strong>. Pilih barang -> Scan QRIS -> Barang keluar otomatis.</p>
       
      <h3>2. Barang Tidak Keluar?</h3>
      <p>Jika pembayaran berhasil tapi barang <strong>tidak keluar/tersangkut</strong>:</p>
      <ul>
        <li>Jangan panik. Sistem kami mencatat semua transaksi sukses.</li>
        <li>Hubungi Admin via WhatsApp yang tertera di layar.</li>
        <li>Sertakan bukti screenshot pembayaran atau jam transaksi.</li>
      </ul>

      <h3>3. Salah Pilih Barang</h3>
      <p>Barang yang sudah dibayar dan keluar dari mesin <strong>tidak dapat ditukar atau dikembalikan</strong> (No Refund).</p>
       
      <h3>4. Stok Live</h3>
      <p>Stok di layar adalah Real-time. Jika stok habis, tombol beli akan terkunci otomatis.</p>
    </div>
  </div>
</div>

<div id="waModal" class="modal-overlay">
  <div class="modal-content" style="text-align: center; max-width: 400px;">
    <span class="close-modal" onclick="closeWaModal()">&times;</span>
      
    <h2 style="border:none; margin-bottom: 5px;">Hubungi Admin</h2>
    <p>Scan QR ini pakai kamera HP untuk chat:</p>
      
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https://wa.me/6281998143531" 
         alt="Scan QR WA" 
         style="width: 200px; height: 200px; margin: 10px 0; border: 2px solid #ddd; padding: 5px; border-radius: 10px;">
      
    <p style="font-weight: bold; font-size: 18px; color: #25D366; margin-top: 0;">
      <i class="fa-brands fa-whatsapp"></i> 0819-9814-3531
    </p>
  </div>
</div>

<script type="text/javascript"
  src="https://app.midtrans.com/snap/snap.js"
  data-client-key="Mid-client-vkVSkv_rBJsbJj7B"> 
</script>

<script>
  // URL WORKER
  const _BASE_URL = "https://vending-machine-server.fahmyainun.workers.dev"; 

  // DAFTAR GAMBAR PRODUK
  const productImages = {
    "p11": "Kue Sus.jpg",
    "p12": "Donat Kentang.jpg",
    "p13": "Roti Labu Kuning.jpg",
    "p14": "Donat Labu Kuning.jpg", 
    "default": "https://via.placeholder.com/150?text=Vending+AAA"
  };

  // FILTER PRODUK (HANYA P11-P14)
  const vendingProductIDs = ["p11", "p12", "p13", "p14"]; 

  document.addEventListener("DOMContentLoaded", () => {
    fetchProducts();
  });

  // --- LOGIC MODAL ---
  const modal = document.getElementById("refundModal");
  const waModal = document.getElementById("waModal");

  function openRefundModal() { modal.style.display = "flex"; }
  function closeRefundModal() { modal.style.display = "none"; }

  function openWaModal() { waModal.style.display = "flex"; }
  function closeWaModal() { waModal.style.display = "none"; }

  window.onclick = function(event) { 
    if (event.target == modal) modal.style.display = "none"; 
    if (event.target == waModal) waModal.style.display = "none";
  }

  // --- FUNGSI AMBIL DATA PRODUK ---
  async function fetchProducts() {
    try {
      const res = await fetch(`${_BASE_URL}/products`);
      if (!res.ok) throw new Error("Gagal ambil data");
        
      const allProducts = await res.json();
      const productsData = allProducts.filter(item => vendingProductIDs.includes(item.id));

      if (productsData.length === 0) {
          document.getElementById("produk-list").innerHTML = `<p style="text-align:center;">Produk vending sedang kosong.</p>`;
          return;
      }
      renderProducts(productsData);
    } catch (err) {
      document.getElementById("produk-list").innerHTML = `<p style="text-align:center; color:red">Gagal memuat: ${err.message}</p>`;
    }
  }

  function renderProducts(products) {
    const container = document.getElementById("produk-list");
    container.innerHTML = "";
     
    products.forEach(p => {
      const imgUrl = productImages[p.id] || productImages["default"];
      const isHabis = p.stock <= 0;
      const hargaFmt = p.price.toLocaleString('id-ID'); 
      
      const div = document.createElement('div');
      div.className = 'produk';
      div.innerHTML = `
          <div class="stok-badge">Stok: ${p.stock}</div>
          <img src="${imgUrl}" alt="${p.name}" onerror="this.onerror=null;this.src='${productImages.default}'">
          <h3>${p.name}</h3>
          <div class="harga">Rp ${hargaFmt}</div>
           
          <button id="btn-${p.id}" class="btn-beli" ${isHabis ? "disabled" : ""}>
            ${isHabis ? "Habis" : "üõí Beli Sekarang"}
          </button>
      `;

      if (!isHabis) {
          div.querySelector('button').onclick = function() {
              beliLangsung(p.id, p.name, p.price);
          };
      }
      container.appendChild(div);
    });
  }

  // ==========================================================
  // --- FUNGSI BELI LANGSUNG (INTI PEMBAYARAN) ---
  // ==========================================================
  async function beliLangsung(id, nama, harga) {
    if (typeof window.snap === 'undefined') {
        alert("Sistem pembayaran sedang loading. Tunggu sebentar...");
        return;
    }
   
    const btnId = "btn-" + id; 
    const btn = document.getElementById(btnId);
    const originalText = btn.innerText;
     
    // Kunci tombol
    btn.innerHTML = "‚è≥ Menghubungi Server...";
    btn.disabled = true;

    const resetButton = () => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    };

    // Buat Order ID Unik
    const myOrderId = "ORDER-" + Date.now() + "-" + Math.floor(Math.random() * 1000); 

    try {
        console.log("1. Meminta Token Midtrans untuk:", id);
        
        // --- 1. MINTA TOKEN KE SERVER WORKER ---
        const tokenResponse = await fetch(`${_BASE_URL}/api/get-token`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                order_id: myOrderId,
                items: [{ id: id, quantity: 1 }], 
                product_name: "Vending: " + nama
            }) 
        });

        const data = await tokenResponse.json();
        
        if (data.error) { throw new Error(data.error); }
        if (!data.token) { throw new Error("Token tidak diterima"); }

        console.log("2. Token diterima. Membuka Snap...");

        // --- 2. TAMPILKAN POPUP MIDTRANS ---
        btn.innerHTML = "üí∞ Silakan Scan QRIS...";
        
        window.snap.pay(data.token, {
            // === DISINI LOGIKA SUKSES ===
            onSuccess: async function(result){
                console.log("3. Pembayaran Sukses! Mengurangi Stok...", result);
                
                // A. Visual UI: Kasih tau user
                btn.innerHTML = "‚úÖ LUNAS";
                btn.style.background = "#27ae60"; 
                
                const layar = document.getElementById("pesan-layar");
                layar.innerText = "üéâ TERIMA KASIH! SILAKAN AMBIL BARANG...";
                layar.style.color = "#2ecc71";
                layar.style.transform = "scale(1.1)"; 

                // B. UPDATE SERVER (PENTING!)
                // Ini menembak endpoint /bayar untuk kurangi stok
                try {
                    await fetch(`${_BASE_URL}/bayar`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            product_id: id,
                            user_token: myOrderId,
                            quantity: 1 
                        })
                    });
                } catch (errSave) {
                    console.error("Gagal update stok server:", errSave);
                }

                // C. Hitung Mundur & Refresh Halaman
                let detik = 5;
                const interval = setInterval(() => {
                    btn.innerHTML = `‚úÖ LUNAS (Reset: ${detik})`;
                    detik--;
                }, 1000);

                setTimeout(() => {
                    clearInterval(interval); 
                    window.location.reload(); // Refresh agar stok terupdate di layar
                }, 5000); 
            },
            onPending: function(result){
                alert("Menunggu pembayaran... Stok belum berkurang.");
                resetButton();
            },
            onError: function(result){
                alert("Pembayaran Gagal. Stok aman.");
                resetButton();
            },
            onClose: function(){
                console.log("Popup ditutup tanpa bayar.");
                resetButton(); 
            }
        });

    } catch (error) {
        console.error("CRITICAL ERROR:", error);
        alert("Gagal koneksi: " + error.message);
        resetButton();
    }
  }

  // --- AUTO REFRESH JIKA TIDAK ADA AKTIVITAS ---
  let idleTime = 0;
  const resetTimer = () => { idleTime = 0; };
  document.onmousemove = resetTimer;
  document.onkeypress = resetTimer;
  document.ontouchstart = resetTimer; 
  document.onclick = resetTimer;

  // Cek setiap 10 menit (600000ms)
  setInterval(() => {
    idleTime++;
    if (idleTime >= 2) { // Jika sudah 2x interval (20 menit) tanpa aktivitas
       window.location.reload(); 
    }
  }, 600000); 
</script>

</body>
</html>
