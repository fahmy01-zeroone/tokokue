<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Toko Cake and Cookies AAA</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f6f6f6; padding: 25px; margin: 0; }
    h1 { text-align: center; margin-bottom: 5px; }
    .subtitle { text-align: center; color: #555; margin-bottom: 30px; }
    
    .produk-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      max-width: 900px;
      margin: auto;
    }

    .produk {
      background: white; padding: 16px; border-radius: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08); text-align: center;
      transition: transform 0.3s ease; position: relative;
    }
    .produk:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.18); }
    
    .produk img {
      width: 100%; height: 160px; object-fit: cover;
      border-radius: 10px; margin-bottom: 10px;
    }

    .stok-badge {
      position: absolute; top: 10px; right: 10px;
      background: rgba(0,0,0,0.6); color: white;
      padding: 4px 8px; border-radius: 6px; font-size: 12px;
    }

    .harga { font-weight: 600; margin: 8px 0; color: #d35400; }
    
    button {
      background: #25D366; color: white; border: none;
      padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;
    }
    button:disabled { background: #ccc; cursor: not-allowed; }

    .cart {
      max-width: 900px; margin: 40px auto 0; background: white;
      padding: 20px; border-radius: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .cart-item {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 10px;
    }
    .qty { display: flex; align-items: center; gap: 6px; }
    .qty input { width: 40px; text-align: center; }

    .total { font-weight: 700; margin-top: 15px; font-size: 18px; text-align: right;}
    .btn-checkout { margin-top: 15px; width: 100%; background: #0d6efd; font-size: 16px; }
    
    .loading-msg { text-align: center; width: 100%; grid-column: 1 / -1; font-style: italic; color: #888; }

    /* --- GAYA POPUP QRIS (BARU) --- */
    .modal-overlay {
      display: none; /* Sembunyikan dulu */
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 999;
      justify-content: center; align-items: center;
    }
    .modal-box {
      background: white; padding: 25px; border-radius: 15px;
      text-align: center; max-width: 350px; width: 90%;
    }
    .modal-box img { width: 200px; margin: 15px 0; border: 1px solid #ddd; padding: 5px; }
    .btn-confirm { background: #0d6efd; width: 100%; margin-top: 10px; padding: 12px; }
    .btn-cancel { background: #dc3545; width: 100%; margin-top: 10px; padding: 12px; }

  </style>
</head>

<body>

<h1>üç∞ Toko Cake and Cookies AAA</h1>
<p class="subtitle">Brownies, cake & cookies homemade (Live Stock)</p>

<div class="produk-container" id="produk-list">
  <div class="loading-msg">‚è≥ Sedang mengambil kue dari oven... (Loading)</div>
</div>

<div class="cart">
  <h2>üß∫ Keranjang Belanja</h2>
  <div id="cart-items"></div>
  <div class="total" id="total">Total: Rp 0</div>
  <button class="btn-checkout" onclick="tampilkanQRIS()">Bayar Sekarang</button>
</div>

<div class="modal-overlay" id="qrisModal">
  <div class="modal-box">
    <h3>Pembayaran QRIS</h3>
    <p>Silakan scan kode di bawah ini untuk membayar sebesar:</p>
    <h2 id="modalTotal">Rp 0</h2>
    
    <img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" alt="QRIS Code">
    
    <p style="font-size: 12px; color: #666;">Stok baru akan berkurang setelah kamu klik tombol konfirmasi di bawah.</p>

    <button class="btn-confirm" onclick="prosesPembayaranKeServer()">‚úÖ Saya Sudah Transfer</button>
    <button class="btn-cancel" onclick="tutupQRIS()">‚ùå Batal</button>
  </div>
</div>

<script>
  // 1. URL SERVER CLOUDFLARE KAMU
  const API_BASE_URL = "https://vending-machine-server.fahmyainun.workers.dev"; 

  // 2. Mapping Gambar
  const productImages = {
    "p1": "brownieskukus.jpg",
    "p2": "boluketanhitam.jpg",
    "p3": "cakecookies.jpg",
    "p4": "bananarolls.jpg", 
    "p5": "fudgybrownies.jpg",
    "default": "https://via.placeholder.com/300?text=Kue+Enak"
  };

  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  let productsData = []; 

  // --- INIT ---
  document.addEventListener("DOMContentLoaded", () => {
    fetchProducts();
    renderCart();
  });

  // --- FUNGSI DATA ---
  async function fetchProducts() {
    try {
      const res = await fetch(`${API_BASE_URL}/products`);
      if (!res.ok) throw new Error("Gagal ambil data");
      productsData = await res.json();
      renderProducts(productsData);
    } catch (err) {
      document.getElementById("produk-list").innerHTML = `<p style="text-align:center; color:red">Gagal memuat produk.</p>`;
    }
  }

  function renderProducts(products) {
    const container = document.getElementById("produk-list");
    container.innerHTML = "";
    products.forEach(p => {
      const imgUrl = productImages[p.id] || productImages["default"];
      const isHabis = p.stock <= 0;
      container.innerHTML += `
        <div class="produk">
          <div class="stok-badge">Stok: ${p.stock}</div>
          <img src="${imgUrl}" onerror="this.src='${productImages.default}'">
          <h3>${p.name}</h3>
          <div class="harga">Rp ${p.price.toLocaleString()}</div>
          <button onclick="addToCart('${p.id}', '${p.name}', ${p.price}, ${p.stock})" ${isHabis ? "disabled" : ""}>
            ${isHabis ? "Habis" : "üõí Beli"}
          </button>
        </div>
      `;
    });
  }

  // --- FUNGSI KERANJANG ---
  function addToCart(id, nama, harga, maxStock) {
    const item = cart.find(p => p.id === id);
    if (item) {
      if (item.qty < maxStock) item.qty++;
      else return alert("Stok tidak cukup!");
    } else {
      cart.push({ id, nama, harga, qty: 1, maxStock });
    }
    saveCart(); renderCart();
  }

  function changeQty(id, delta) {
    const item = cart.find(p => p.id === id);
    if (!item) return;
    const newQty = item.qty + delta;
    if (newQty > item.maxStock) return alert("Stok mentok!");
    item.qty = newQty;
    if (item.qty <= 0) cart = cart.filter(p => p.id !== id);
    saveCart(); renderCart();
  }

  function renderCart() {
    const el = document.getElementById("cart-items");
    el.innerHTML = "";
    let total = 0;
    cart.forEach(i => {
      total += i.harga * i.qty;
      el.innerHTML += `
        <div class="cart-item">
          <div><strong>${i.nama}</strong><br><small>Rp ${i.harga.toLocaleString()}</small></div>
          <div class="qty">
            <button onclick="changeQty('${i.id}', -1)">‚àí</button>
            <input type="text" value="${i.qty}" readonly>
            <button onclick="changeQty('${i.id}', 1)">+</button>
          </div>
        </div>`;
    });
    document.getElementById("total").innerText = "Total: Rp " + total.toLocaleString();
    
    // Update Total di Modal juga
    document.getElementById("modalTotal").innerText = "Rp " + total.toLocaleString();
  }

  function saveCart() { localStorage.setItem("cart", JSON.stringify(cart)); }

  // --- LOGIKA PEMBAYARAN BARU (QRIS DULU, BARU POTONG STOK) ---

  // 1. Tampilkan Popup QRIS
  function tampilkanQRIS() {
    if (!cart.length) return alert("Keranjang kosong!");
    document.getElementById("qrisModal").style.display = "flex";
  }

  // 2. Tutup Popup
  function tutupQRIS() {
    document.getElementById("qrisModal").style.display = "none";
  }

  // 3. Proses Ke Server (DIJALANKAN SETELAH KLIK "SAYA SUDAH TRANSFER")
  async function prosesPembayaranKeServer() {
    const btn = document.querySelector(".btn-confirm");
    btn.innerHTML = "‚è≥ Memproses...";
    btn.disabled = true;

    const userToken = "user_" + Math.floor(Math.random() * 10000);
    let suksesCount = 0;

    // Loop kirim data per item ke server
    for (const item of cart) {
      try {
        const payload = {
          product_id: item.id,
          user_token: userToken,
          quantity: item.qty
        };

        const res = await fetch(`${API_BASE_URL}/bayar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const hasil = await res.json();
        if (res.ok && hasil.success) suksesCount++;

      } catch (err) { console.error("Error:", err); }
    }

    // Selesai
    tutupQRIS();
    btn.innerHTML = "‚úÖ Saya Sudah Transfer";
    btn.disabled = false;

    if (suksesCount === cart.length) {
      alert("Pembayaran Berhasil! Stok sudah dikurangi.");
      cart = []; // Kosongkan keranjang
      saveCart();
      renderCart();
      fetchProducts(); // Refresh stok di layar
    } else {
      alert("Transaksi selesai, tapi ada item yang gagal (mungkin kehabisan stok).");
      fetchProducts();
    }
  }

</script>

</body>
</html>
